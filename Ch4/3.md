# veloportì™€ í•¨ê»˜í•˜ëŠ” ëª¨ë˜ ë¦¬ì•¡íŠ¸

## 4ì¥ - ë¦¬ì•¡íŠ¸ API ì—°ë™

### API ìƒíƒœê°’ ê´€ë¦¬í•˜ê¸° - 1ï¸âƒ£ Custom Hook ë§Œë“¤ì–´ì„œ ê´€ë¦¬í•˜ê¸°

> **Custom Hookìœ¼ë¡œ ìƒíƒœ ë¡œì§ ê´€ë¦¬í•˜ê¸°**

- Custom Hookì„ ë§Œë“¤ì–´ì„œ State ê´€ë ¨ ë¡œì§ì„ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
- ê°™ì€ ì‘ì—…ì„ ë§¤ë²ˆ reducer í•¨ìˆ˜ë¡œ ë§Œë“¤ì–´ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ë¹„íš¨ìœ¨ì ì´ë¯€ë¡œ, ë°˜ë³µì ì¸ ì‘ì—…ì€ Custom Hookì„ ë§Œë“¤ì–´ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.
  <br>

> **EX1: Custom Hookìœ¼ë¡œ ìƒíƒœ ë¡œì§ ê´€ë¦¬í•˜ê¸°**

```javascript
// src/useAsync.js
import { useReducer, useEffect, useCallback } from "react";

// ë¹„ë™ê¸° ì²˜ë¦¬ì— ëŒ€í•œ ìƒíƒœê°’ ê´€ë¦¬ ë¡œì§ (reducer í•¨ìˆ˜)
function reducer(state, action) {
  switch (action.type) {
    case "LOADING":
      return {
        loading: true,
        data: null,
        error: null,
      };
    case "SUCCESS":
      return {
        loading: false,
        data: action.data,
        error: null,
      };
    case "ERROR":
      return {
        loading: false,
        data: null,
        error: action.error,
      };
    default:
      throw new Error(`Unhandled Action Type: ${action.type}`);
  }
}

// ë¹„ë™ê¸° í•¨ìˆ˜(callback), dependency array, skip
// **skipì€ mountì‹œ ë¹„ë™ê¸° ì²˜ë¦¬ í•¨ìˆ˜ì˜ ì§„í–‰ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ê¸° ìœ„í•œ ë³€ìˆ˜
function useAsync(callback, deps = [], skip = false) {
  const [state, dispatch] = useReducer(reducer, {
    loading: false,
    data: null,
    error: null,
  });

  const fetchData = useCallback(async () => {
    dispatch({ type: "LOADING" });
    try {
      // ë¹„ë™ê¸° í•¨ìˆ˜ë¥¼ ì…ë ¥ë°›ì•„ì„œ, í•´ë‹¹ ë¹„ë™ê¸° ì²˜ë¦¬ ë° ìƒíƒœ ê°’ì„ ë³€í™˜í•´ì¤Œ
      const data = await callback();
      dispatch({ type: "SUCCESS", data: data });
    } catch (e) {
      dispatch({ type: "ERROR", error: e });
      console.log(e.message);
    }
  }, [callback]);

  useEffect(() => {
    if (skip) return;
    fetchData();
    // eslint ì„¤ì •ì„ ë‹¤ìŒ ì¤„ì—ì„œë§Œ ë¹„í™œì„±í™”
    /* eslint-disable-next-line */
  }, deps);

  return [state, fetchData];
}

export default useAsync;
```

```javascript
// src/Users.js
import React from "react";
import axios from "axios";
// Custom Hook ë¶ˆëŸ¬ì˜¤ê¸°
import useAsync from "./useAsync";

// useAsync ì—ì„œëŠ” Promise ì˜ ê²°ê³¼ë¥¼ ë°”ë¡œ data ì— ë‹´ê¸° ë•Œë¬¸ì—,
// ìš”ì²­ì„ í•œ ì´í›„ response ì—ì„œ data ì¶”ì¶œí•˜ì—¬ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ë¥¼ ë”°ë¡œ ë§Œë“ ë‹¤.
async function getUsers() {
  const response = await axios.get(
    "https://jsonplaceholder.typicode.com/users"
  );
  return response.data;
}

function Users() {
  // Custom Hook ì‚¬ìš©í•´ ìƒíƒœ(state)ì™€, ë¹„ë™ê¸° ì²˜ë¦¬ ë¡œì§ í•¨ìˆ˜(refetch) ê°€ì ¸ì˜¤ê¸°
  const [state, refetch] = useAsync(getUsers, [], true);

  const { loading, data: users, error } = state; // state.data ë¥¼ users í‚¤ì›Œë“œë¡œ ì¡°íšŒ

  if (loading) return <div>ë¡œë”©ì¤‘..</div>;
  if (error) return <div>ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>;
  if (!users) return <button onClick={refetch}>ë¶ˆëŸ¬ì˜¤ê¸°</button>;
  return (
    <>
      <ul>
        {users.map((user) => (
          <li key={user.id}>
            {user.username} ({user.name})
          </li>
        ))}
      </ul>
      <button onClick={refetch}>ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </>
  );
}

export default Users;
```

<br>

> **EX2: API URIì— íŠ¹ì • íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•  ë•Œ**

- propsë¡œ ë°›ì•„ì™€, ë¹„ë™ê¸° ì²˜ë¦¬ ë¡œì§ì— ì „ë‹¬í•´ì„œ êµ¬í˜„í•œë‹¤.

```javascript
// src/User.js
import React from "react";
import axios from "axios";
// ìœ„ì—ì„œ ë§Œë“  Custom Hookìœ¼ë¡œ ë¹„ë™ê¸° ì²˜ë¦¬ ë¡œì§ ì¬ì‚¬ìš©
import useAsync from "./useAsync";

// Custom Hookì˜ ì¸ìë¡œ ë“¤ì–´ê°ˆ ë¹„ë™ê¸° ì²˜ë¦¬ í•¨ìˆ˜ì—
// APIí˜¸ì¶œ ì‹œ URIì— ë“¤ì–´ê°ˆ íŒŒë¼ë¯¸í„°ë¥¼ ì…ë ¥ë°›ë„ë¡ êµ¬í˜„í•œë‹¤.
async function getUser(id) {
  const response = await axios.get(
    `https://jsonplaceholder.typicode.com/users/${id}`
  );
  return response.data;
}

// APIí˜¸ì¶œ ì‹œ URIì— ë“¤ì–´ê°ˆ íŒŒë¼ë¯¸í„°ë¥¼ propsë¡œ ë°›ì•„ getUser í•¨ìˆ˜ì— ì „ë‹¬í•œë‹¤.
function User({ id }) {
  // stateê°’ ê°€ì ¸ì˜¤ê¸°
  const [state] = useAsync(() => getUser(id), [id]);
  const { loading, data: user, error } = state;

  if (loading) return <div>ë¡œë”©ì¤‘..</div>;
  if (error) return <div>ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>;
  if (!user) return null;

  return (
    <div>
      <h2>{user.username}</h2>
      <p>
        <b>Email:</b> {user.email}
      </p>
    </div>
  );
}

export default User;
```

```javascript
import React, { useState } from "react";
import axios from "axios";
import useAsync from "./useAsync";
import User from "./User";

async function getUsers() {
  const response = await axios.get(
    "https://jsonplaceholder.typicode.com/users"
  );
  return response.data;
}

function Users() {
  // User ì»´í¬ë„ŒíŠ¸ì— ì „ë‹¬í•  userIdì˜ ê°’ì„ useStateë¥¼ í†µí•´, Users ì»´í¬ë„ŒíŠ¸ ìƒíƒœê°’ìœ¼ë¡œ ê´€ë¦¬
  const [userId, setUserId] = useState(null);
  const [state, refetch] = useAsync(getUsers, [], true);

  const { loading, data: users, error } = state;

  if (loading) return <div>ë¡œë”©ì¤‘..</div>;
  if (error) return <div>ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>;
  if (!users) return <button onClick={refetch}>ë¶ˆëŸ¬ì˜¤ê¸°</button>;
  return (
    <div>
      <ul>
        {users.map((user) => (
          <li
            key={user.id}
            {/*
                íŠ¹ì • li ìš”ì†Œë¥¼ ì…ë ¥í•˜ë©´,
                í•´ë‹¹ user.idë¥¼ Users ì»´í¬ë„ŒíŠ¸ì˜ stateì¸ userIdì— ì „ë‹¬
            */}
            onClick={() => setUserId(user.id)}
            style={{ cursor: "pointer" }}
          >
            {user.username} ({user.name})
          </li>
        ))}
      </ul>
      <button onClick={refetch}>ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      {/* ë§Œì•½ userIdê°€ ìœ íš¨í•˜ë©´(nullì´ ì•„ë‹ˆë©´), í•´ë‹¹ User ì»´í¬ë„ŒíŠ¸ ë Œë”ë§ */}
      {userId && <User id={userId} />}
    </div>
  );
}

export default Users;
```

## Reference

- ë²¨ë¡œí¼íŠ¸ì™€ í•¨ê»˜í•˜ëŠ” ëª¨ë˜ ë¦¬ì•¡íŠ¸ - 4ì¥ <https://react.vlpt.us/integrate-api/03-useAsync.html>
  <br>

[ğŸ‘ˆğŸ»PREV](https://github.com/ss-won/veloport-react/blob/master/Ch4/2.md) |
[NEXTğŸ‘‰ğŸ»](https://github.com/ss-won/veloport-react/blob/master/Ch4/4.md) <br>
[ëŒì•„ê°€ê¸°](https://github.com/ss-won/veloport-react)
